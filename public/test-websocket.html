<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebSocket Connection Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
    }
    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      font-weight: bold;
    }
    .status.connected {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status.disconnected {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .status.connecting {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    button {
      padding: 10px 20px;
      margin: 5px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }
    button:hover {
      background: #0056b3;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    #log {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 15px;
      margin-top: 20px;
      max-height: 400px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
    }
    .log-entry {
      margin: 5px 0;
      padding: 5px;
      border-left: 3px solid #007bff;
      padding-left: 10px;
    }
    .log-entry.error {
      border-left-color: #dc3545;
      color: #dc3545;
    }
    .log-entry.success {
      border-left-color: #28a745;
      color: #28a745;
    }
    input {
      padding: 8px;
      margin: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
      width: 300px;
    }
    .form-container {
      background: #f9f9f9;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
      border: 1px solid #ddd;
    }
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 15px;
      margin-bottom: 15px;
      align-items: center;
    }
    .form-grid label {
      font-weight: bold;
      color: #333;
    }
    .form-grid input[type="text"],
    .form-grid input[type="number"] {
      width: 100%;
      margin: 0;
    }
    .input-with-button {
      display: flex;
      gap: 5px;
      align-items: center;
    }
    .input-with-button input {
      flex: 1;
    }
    .input-with-button button {
      padding: 8px 12px;
      font-size: 14px;
      white-space: nowrap;
      margin: 0;
    }
    .radio-group {
      display: flex;
      gap: 15px;
      align-items: center;
    }
    .radio-group label {
      font-weight: normal;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .required {
      color: red;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>WebSocket Connection Test</h1>
    <p>Test connection to your 3rd party app WebSocket server</p>
    
    <div>
      <label>WebSocket URL:</label><br>
      <input type="text" id="wsUrl" value="ws://127.0.0.1:9000/service" placeholder="ws://127.0.0.1:9000/service">
    </div>
    
    <div style="margin: 20px 0;">
      <button id="connectBtn" onclick="connect()">Connect</button>
      <button id="disconnectBtn" onclick="disconnect()" disabled>Disconnect</button>
      <button id="testSendBtn" onclick="testSend()" disabled>Send Data to 3rd Party App</button>
      <button onclick="clearLog()">Clear Log</button>
    </div>
    
    <div id="status" class="status disconnected">Disconnected</div>

    <!-- Form for all input fields -->
    <div class="form-container">
      <h2>Cargo Transportation Information</h2>
      <form id="cargoForm">
        <div class="form-grid">
          <label for="packageInput">–ë–∞–≥–ª–∞–∞ –±–æ–æ–¥–æ–ª (Package/Packing):</label>
          <div class="input-with-button">
            <input type="number" id="packageInput" name="package" step="0.01" value="0.00" />
            <button type="button" onclick="selectPackage()">–°–æ–Ω–≥–æ—Ö</button>
          </div>
        </div>

        <div class="form-grid">
          <label for="netInput">–¶—ç–≤—ç—Ä –∂–∏–Ω (Net Weight):</label>
          <div class="input-with-button">
            <input type="number" id="netInput" name="net" step="0.01" value="0.00" />
            <button type="button" id="calculateNetBtn" onclick="calculateNetWeight()">Calculate</button>
          </div>
        </div>

        <div class="form-grid">
          <label for="wgtInput"><span class="required">*</span> –ë–æ—Ö–∏—Ä –∂–∏–Ω (Gross Weight):</label>
          <div class="input-with-button">
            <input type="number" id="wgtInput" name="wgt" step="0.01" value="0.00" required />
            <button type="button">–ö–ì</button>
          </div>
        </div>

        <div class="form-grid">
          <label for="aktInput">–ü“Ø“Ø–Ω–∏–π –∞–∫—Ç (Company Act / AKT):</label>
          <input type="text" id="aktInput" name="akt" />
        </div>

        <div class="form-grid">
          <label for="lpcInput"><span class="required">*</span> –¢—ç—ç–≤—ç—Ä–ª—ç–≥—á –±–∞–π–≥—É—É–ª–ª–∞–≥—ã–Ω –Ω—ç—Ä (Carrier Organization Name / LPC):</label>
          <input type="text" id="lpcInput" name="lpc" required />
        </div>

        <div class="form-grid">
          <label for="drnInput">–ñ–æ–ª–æ–æ—á–∏–π–Ω –Ω—ç—Ä (Driver's Name / DRN):</label>
          <input type="text" id="drnInput" name="drn" />
        </div>

        <div class="form-grid">
          <label for="trlInput">–ß–∏—Ä–≥“Ø“Ø–ª–∏–π–Ω –¥—É–≥–∞–∞—Ä (Trailer Number / TRL):</label>
          <input type="text" id="trlInput" name="trl" />
        </div>

        <div class="form-grid">
          <label for="slnInput">–ì–∞–∞–ª–∏–π–Ω –ª–∞—Ü –ª–æ–º–±—ã–Ω –¥—É–≥–∞–∞—Ä (Customs Seal Number / SLN):</label>
          <input type="text" id="slnInput" name="sln" />
        </div>

        <div class="form-grid">
          <label for="carInput">CAR (Cargo/Product):</label>
          <input type="text" id="carInput" name="car" />
        </div>

        <div class="form-grid">
          <label for="conInput">CON (Contract):</label>
          <input type="text" id="conInput" name="con" />
        </div>

        <div class="form-grid">
          <label for="upcInput">UPC (Unloading Point Company):</label>
          <input type="text" id="upcInput" name="upc" />
        </div>

        <div class="form-grid">
          <label for="vnoInput">VNO (Vehicle Number / Plate):</label>
          <input type="text" id="vnoInput" name="vno" />
        </div>

        <div class="form-grid">
          <label for="ct1Input">CT1 (Custom Field 1):</label>
          <input type="text" id="ct1Input" name="ct1" />
        </div>

        <div class="form-grid">
          <label for="cmnInput">CMN (Comments/Notes):</label>
          <input type="text" id="cmnInput" name="cmn" />
        </div>

        <div class="form-grid">
          <label>–•–∏–ª –¥—ç—ç—Ä—Ö —Ç—ç—ç–≤—Ä–∏–π–Ω —Ö—ç—Ä—ç–≥—Å–ª–∏–π–Ω –¥—É–≥–∞–∞—Ä —Å–æ–ª–∏—Ö —ç—Å—ç—Ö? (Change Vehicle Number at Border?):</label>
          <div class="radio-group">
            <label>
              <input type="radio" name="changeVehicleNumber" value="no" checked />
              “Æ–≥“Ø–π (No)
            </label>
            <label>
              <input type="radio" name="changeVehicleNumber" value="yes" />
              –¢–∏–π–º (Yes)
            </label>
          </div>
        </div>
      </form>
    </div>

    <!-- Current Data Preview -->
    <div class="form-container" style="margin-top: 20px;">
      <h3>Current Data to Send:</h3>
      <div id="dataPreview" style="background: #fff; padding: 15px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto;">
        <em>Fill in the form above to see data preview...</em>
      </div>
      <button type="button" onclick="updateDataPreview()" style="margin-top: 10px; padding: 8px 16px; font-size: 14px;">Refresh Preview</button>
    </div>
    
    <div>
      <h3>Connection Log:</h3>
      <div id="log"></div>
    </div>
  </div>

  <script>
    let ws = null;
    const statusEl = document.getElementById('status');
    const logEl = document.getElementById('log');
    const connectBtn = document.getElementById('connectBtn');
    const disconnectBtn = document.getElementById('disconnectBtn');
    const testSendBtn = document.getElementById('testSendBtn');
    const wsUrlInput = document.getElementById('wsUrl');

    function log(message, type = 'info') {
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      const timestamp = new Date().toLocaleTimeString();
      entry.textContent = `[${timestamp}] ${message}`;
      logEl.appendChild(entry);
      logEl.scrollTop = logEl.scrollHeight;
      console.log(message);
    }

    function updateStatus(status, message) {
      statusEl.className = `status ${status}`;
      statusEl.textContent = message;
    }

    function connect() {
      const url = wsUrlInput.value.trim();
      if (!url) {
        log('Please enter a WebSocket URL', 'error');
        return;
      }

      log(`Attempting to connect to: ${url}`, 'info');
      updateStatus('connecting', 'Connecting...');
      connectBtn.disabled = true;

      try {
        ws = new WebSocket(url);

        ws.onopen = () => {
          log('‚úÖ WebSocket connected successfully!', 'success');
          updateStatus('connected', 'Connected');
          connectBtn.disabled = true;
          disconnectBtn.disabled = false;
          testSendBtn.disabled = false;
        };

        ws.onmessage = (event) => {
          log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'success');
          log('üì• MESSAGE RECEIVED FROM 3RD PARTY APP!', 'success');
          log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'success');
          log(`üì• Response: ${event.data}`, 'success');
          log('‚úÖ This confirms the 3rd party app received your data', 'success');
        };

        ws.onerror = (error) => {
          log(`‚ùå WebSocket error: ${error}`, 'error');
          updateStatus('disconnected', 'Connection Error');
        };

        ws.onclose = (event) => {
          log(`‚ö†Ô∏è WebSocket closed. Code: ${event.code}, Reason: ${event.reason || 'No reason provided'}`, 'error');
          updateStatus('disconnected', 'Disconnected');
          connectBtn.disabled = false;
          disconnectBtn.disabled = true;
          testSendBtn.disabled = true;
          ws = null;
        };
      } catch (error) {
        log(`‚ùå Failed to create WebSocket: ${error.message}`, 'error');
        updateStatus('disconnected', 'Connection Failed');
        connectBtn.disabled = false;
      }
    }

    function disconnect() {
      if (ws) {
        ws.close();
        ws = null;
      }
    }

    // Generate a unique code (8 digits, all numbers)
    function generateUniqueCode() {
      const digits = "0123456789";
      let code = "";
      for (let i = 0; i < 8; i++) {
        code += digits.charAt(Math.floor(Math.random() * digits.length));
      }
      return code;
    }

    // Calculate net weight from gross weight
    function calculateNetWeight() {
      const wgtInput = document.getElementById('wgtInput');
      const netInput = document.getElementById('netInput');
      const packageInput = document.getElementById('packageInput');
      
      if (!wgtInput || !netInput) {
        log('‚ùå WGT or NET input not found', 'error');
        return;
      }
      
      const grossWeight = parseFloat(wgtInput.value) || 0;
      const packageWeight = parseFloat(packageInput.value) || 0;
      
      if (grossWeight <= 0) {
        alert('Please enter a valid gross weight (WGT) first');
        return;
      }
      
      // Net weight calculation: NET = WGT - Package Weight (Tare)
      const netWeight = grossWeight - packageWeight;
      
      netInput.value = netWeight > 0 ? netWeight.toFixed(2) : 0;
      log(`‚úÖ Calculated NET: ${netWeight.toFixed(2)} (WGT: ${grossWeight} - Package: ${packageWeight})`, 'success');
    }

    // Placeholder for package selection
    function selectPackage() {
      log('Package selection - implement as needed', 'info');
      // You can implement a modal or dropdown for package selection here
    }

    // Get current form data
    function getFormData() {
      return {
        uniqueCode: generateUniqueCode(), // Unrepeatable code for pulling data
        CAR: document.getElementById('carInput')?.value.trim() || "",
        CON: document.getElementById('conInput')?.value.trim() || "",
        DRN: document.getElementById('drnInput')?.value.trim() || "",
        LPC: document.getElementById('lpcInput')?.value.trim() || "",
        SLN: document.getElementById('slnInput')?.value.trim() || "",
        TRL: document.getElementById('trlInput')?.value.trim() || "",
        UPC: document.getElementById('upcInput')?.value.trim() || "",
        AKT: document.getElementById('aktInput')?.value.trim() || "",
        NET: parseFloat(document.getElementById('netInput')?.value) || 0,
        WGT: parseFloat(document.getElementById('wgtInput')?.value) || 0,
        VNO: document.getElementById('vnoInput')?.value.trim() || "",
        CT1: document.getElementById('ct1Input')?.value.trim() || "",
        CMN: document.getElementById('cmnInput')?.value.trim() || "",
        // Additional fields
        PKG: parseFloat(document.getElementById('packageInput')?.value) || 0, // Package/Packing weight
        CHG_VNO: document.querySelector('input[name="changeVehicleNumber"]:checked')?.value || "no" // Change vehicle number at border
      };
    }

    // Update data preview
    function updateDataPreview() {
      const previewEl = document.getElementById('dataPreview');
      if (!previewEl) return;

      const formData = getFormData();
      const jsonData = JSON.stringify(formData, null, 2);
      previewEl.textContent = jsonData;
      previewEl.style.color = '#333';
    }

    function testSend() {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        log('‚ùå WebSocket is not connected. Current state: ' + (ws ? ws.readyState : 'null'), 'error');
        log('‚ùå WebSocket states: CONNECTING=0, OPEN=1, CLOSING=2, CLOSED=3', 'error');
        return;
      }

      // Get form data from all inputs (fresh read each time)
      const formData = getFormData();
      const jsonData = JSON.stringify(formData, null, 2);
      
      // Update preview to show what's being sent NOW
      updateDataPreview();
      
      log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
      log('üì§ PREPARING TO SEND TEST DATA TO 3RD PARTY APP', 'info');
      log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
      log(`üîë Unique Code: ${formData.uniqueCode}`, 'info');
      log(`üìä WebSocket State: ${ws.readyState} (OPEN=1)`, 'info');
      log(`üìä WebSocket URL: ${wsUrlInput.value}`, 'info');
      log(`üì¶ Data Size: ${jsonData.length} bytes`, 'info');
      log('', 'info');
      log('üìã Full JSON Data:', 'info');
      log(jsonData, 'info');
      log('', 'info');
      
      try {
        // Verify connection one more time
        if (ws.readyState !== WebSocket.OPEN) {
          log('‚ùå ERROR: WebSocket closed before send! State: ' + ws.readyState, 'error');
          return;
        }
        
        // Send the data
        ws.send(jsonData);
        
        log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'success');
        log('‚úÖ DATA SENT SUCCESSFULLY!', 'success');
        log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'success');
        log(`‚úÖ Message sent via ws.send()`, 'success');
        log(`‚úÖ Bytes sent: ${jsonData.length}`, 'success');
        log(`‚úÖ Unique Code sent: ${formData.uniqueCode}`, 'success');
        log('', 'success');
        log('üí° Check your 3rd party app to verify it received the data', 'info');
        log('üí° The app should show this data in its autofill/form', 'info');
        log('üí° If the app has logs, check them to confirm receipt', 'info');
        
        // Check connection after a short delay
        setTimeout(() => {
          if (ws && ws.readyState === WebSocket.OPEN) {
            log('‚úÖ WebSocket still connected after send', 'success');
          } else {
            log('‚ö†Ô∏è WebSocket closed after send. State: ' + (ws ? ws.readyState : 'null'), 'error');
          }
        }, 100);
        
      } catch (error) {
        log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'error');
        log('‚ùå ERROR SENDING DATA', 'error');
        log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'error');
        log(`‚ùå Error: ${error.message}`, 'error');
        log(`‚ùå Error type: ${error.name}`, 'error');
        if (error.stack) {
          log(`‚ùå Stack: ${error.stack}`, 'error');
        }
      }
    }

    function clearLog() {
      logEl.innerHTML = '';
    }

    // Update preview when inputs change
    function setupFormListeners() {
      const inputs = document.querySelectorAll('#cargoForm input');
      inputs.forEach(input => {
        input.addEventListener('input', updateDataPreview);
        input.addEventListener('change', updateDataPreview);
      });
    }

    // Auto-connect on page load
    window.addEventListener('load', () => {
      log('WebSocket Test Page Loaded', 'info');
      log('Click "Connect" to test your WebSocket server', 'info');
      setupFormListeners();
      updateDataPreview();
    });
  </script>
</body>
</html>

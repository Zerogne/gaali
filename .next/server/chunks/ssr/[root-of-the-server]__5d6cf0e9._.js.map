{"version":3,"sources":["../../../../lib/api.ts","../../../../.next-internal/server/app/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["\"use server\"\n\nimport { getCompanyCollection } from \"@/lib/db/companyDb\"\nimport { getActiveCompany } from \"@/lib/auth/session\"\nimport { truckLogSchema } from \"@/lib/validation\"\nimport { handleError, ValidationError } from \"@/lib/errors\"\nimport type { TruckLog } from \"./types\"\n\n/**\n * Save truck log to company-scoped collection\n * Uses the active company from session\n * Includes input validation\n */\nexport async function saveTruckLog(\n  log: Omit<TruckLog, \"id\" | \"createdAt\" | \"sentToCustoms\">\n): Promise<TruckLog> {\n  try {\n    // Validate input\n    const validation = truckLogSchema.safeParse(log)\n    if (!validation.success) {\n      throw new ValidationError(\n        \"Invalid truck log data\",\n        validation.error.issues.reduce((acc, issue) => {\n          const path = issue.path.join(\".\")\n          acc[path] = issue.message\n          return acc\n        }, {} as Record<string, string>)\n      )\n    }\n\n    // Get active company from session\n    const companyId = await getActiveCompany()\n\n    // Get company-scoped logs collection\n    const logsCollection = await getCompanyCollection<TruckLog>(companyId, \"logs\")\n\n    // Create log document\n    const logDoc: TruckLog = {\n      ...validation.data,\n      id: `truck-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\n      createdAt: new Date().toISOString(),\n      sentToCustoms: false,\n    }\n\n    // Insert into company's collection\n    await logsCollection.insertOne(logDoc)\n\n    return logDoc\n  } catch (error) {\n    const handled = handleError(error)\n    throw new Error(handled.message)\n  }\n}\n\n/**\n * Send truck log to customs\n * Reads from and updates company-scoped collection\n * Includes error handling\n */\nexport async function sendTruckLogToCustoms(\n  logId: string\n): Promise<{ success: boolean; error?: string }> {\n  try {\n    // Validate logId\n    if (!logId || typeof logId !== 'string' || logId.trim().length === 0) {\n      return {\n        success: false,\n        error: \"Invalid log ID\",\n      }\n    }\n\n    // Get active company from session\n    const companyId = await getActiveCompany()\n\n    // Get company-scoped logs collection\n    const logsCollection = await getCompanyCollection<TruckLog>(companyId, \"logs\")\n\n    // Find the log in company's collection\n    const log = await logsCollection.findOne({ id: logId.trim() })\n\n    if (!log) {\n      return {\n        success: false,\n        error: \"Log not found\",\n      }\n    }\n\n    // Simulate network delay\n    await new Promise((resolve) => setTimeout(resolve, 1000))\n\n    // Simulate occasional network errors (10% chance)\n    if (Math.random() < 0.1) {\n      return {\n        success: false,\n        error: \"Network error: Unable to connect to customs system\",\n      }\n    }\n\n    // Update log status in company's collection\n    await logsCollection.updateOne(\n      { id: logId.trim() },\n      { $set: { sentToCustoms: true } }\n    )\n\n    return { success: true }\n  } catch (error) {\n    const handled = handleError(error)\n    return {\n      success: false,\n      error: handled.message,\n    }\n  }\n}\n\n/**\n * Get truck logs for the active company with pagination\n * Serializes MongoDB documents to plain objects for Client Components\n */\nexport async function getTruckLogs(\n  page: number = 1,\n  limit: number = 50\n): Promise<{ logs: TruckLog[]; total: number; page: number; limit: number; totalPages: number }> {\n  try {\n    const companyId = await getActiveCompany()\n    const logsCollection = await getCompanyCollection<TruckLog>(companyId, \"logs\")\n\n    // Validate pagination params\n    const validPage = Math.max(1, Math.floor(page))\n    const validLimit = Math.min(100, Math.max(1, Math.floor(limit)))\n    const skip = (validPage - 1) * validLimit\n\n    // Get total count\n    const total = await logsCollection.countDocuments({})\n\n    // Fetch logs with pagination, sorted by creation date (newest first)\n    const logs = await logsCollection\n      .find({})\n      .sort({ createdAt: -1 })\n      .skip(skip)\n      .limit(validLimit)\n      .toArray()\n\n    // Serialize MongoDB documents to plain objects\n    const serializedLogs = logs.map((doc) => {\n      const { _id, createdAt, ...log } = doc as any\n      return {\n        ...log,\n        createdAt: typeof createdAt === 'string' \n          ? createdAt \n          : (createdAt instanceof Date \n              ? createdAt.toISOString() \n              : new Date(createdAt).toISOString()),\n      } as TruckLog\n    })\n\n    return {\n      logs: serializedLogs,\n      total,\n      page: validPage,\n      limit: validLimit,\n      totalPages: Math.ceil(total / validLimit),\n    }\n  } catch (error) {\n    const handled = handleError(error)\n    throw new Error(handled.message)\n  }\n}\n\n/**\n * Get a single truck log by ID (company-scoped)\n * Serializes MongoDB document to plain object for Client Components\n */\nexport async function getTruckLog(logId: string): Promise<TruckLog | null> {\n  const companyId = await getActiveCompany()\n  const logsCollection = await getCompanyCollection<TruckLog>(companyId, \"logs\")\n\n  const log = await logsCollection.findOne({ id: logId })\n  \n  if (!log) return null\n\n  // Serialize MongoDB document to plain object\n  const { _id, createdAt, ...logData } = log as any\n  return {\n    ...logData,\n    createdAt: typeof createdAt === 'string' \n      ? createdAt \n      : (createdAt instanceof Date \n          ? createdAt.toISOString() \n          : new Date(createdAt).toISOString()),\n  } as TruckLog\n}\n\n/**\n * Update an existing truck log (only if not sent to customs)\n * Uses the active company from session\n * Includes input validation\n */\nexport async function updateTruckLog(\n  logId: string,\n  updates: Partial<Omit<TruckLog, \"id\" | \"createdAt\" | \"sentToCustoms\">>\n): Promise<{ success: boolean; error?: string; log?: TruckLog }> {\n  try {\n    // Get active company from session\n    const companyId = await getActiveCompany()\n\n    // Get company-scoped logs collection\n    const logsCollection = await getCompanyCollection<TruckLog>(companyId, \"logs\")\n\n    // Find the log\n    const existingLog = await logsCollection.findOne({ id: logId })\n\n    if (!existingLog) {\n      return {\n        success: false,\n        error: \"Log not found\",\n      }\n    }\n\n    // Prevent editing logs that have been sent to customs\n    if (existingLog.sentToCustoms) {\n      return {\n        success: false,\n        error: \"Cannot edit logs that have been sent to customs\",\n      }\n    }\n\n    // Validate updates if provided\n    if (Object.keys(updates).length > 0) {\n      const validation = truckLogSchema.partial().safeParse(updates)\n      if (!validation.success) {\n        throw new ValidationError(\n          \"Invalid update data\",\n          validation.error.issues.reduce((acc, issue) => {\n            const path = issue.path.join(\".\")\n            acc[path] = issue.message\n            return acc\n          }, {} as Record<string, string>)\n        )\n      }\n    }\n\n    // Update the log (preserve id, createdAt, sentToCustoms)\n    const updatedLog = {\n      ...existingLog,\n      ...updates,\n      id: existingLog.id,\n      createdAt: existingLog.createdAt,\n      sentToCustoms: existingLog.sentToCustoms,\n      updatedAt: new Date().toISOString(),\n    }\n\n    await logsCollection.updateOne(\n      { id: logId },\n      { $set: updatedLog }\n    )\n\n    // Fetch the updated document to ensure we have the latest version\n    const updatedDoc = await logsCollection.findOne({ id: logId })\n    \n    if (!updatedDoc) {\n      return {\n        success: false,\n        error: \"Failed to retrieve updated log\",\n      }\n    }\n\n    // Serialize MongoDB document to plain object (remove _id, convert Date objects)\n    // Create a plain object copy to avoid any MongoDB-specific properties\n    const doc = updatedDoc as any\n    const serializedLog: TruckLog = {\n      id: doc.id,\n      direction: doc.direction,\n      plate: doc.plate,\n      driverName: doc.driverName,\n      cargoType: doc.cargoType,\n      weightKg: doc.weightKg,\n      comments: doc.comments,\n      origin: doc.origin,\n      destination: doc.destination,\n      senderOrganization: doc.senderOrganization,\n      receiverOrganization: doc.receiverOrganization,\n      sentToCustoms: doc.sentToCustoms,\n      createdAt: typeof doc.createdAt === 'string' \n        ? doc.createdAt \n        : (doc.createdAt instanceof Date \n            ? doc.createdAt.toISOString() \n            : (doc.createdAt ? new Date(doc.createdAt).toISOString() : new Date().toISOString())),\n    }\n\n    return {\n      success: true,\n      log: serializedLog,\n    }\n  } catch (error) {\n    const handled = handleError(error)\n    return {\n      success: false,\n      error: handled.message,\n    }\n  }\n}\n","export {logout as '002aaa44fc4d8d053062b4a4224916d4927773c390'} from 'ACTIONS_MODULE0'\nexport {saveTruckLog as '4058b122e308e364a24ba05695bd0c197e19386dfe'} from 'ACTIONS_MODULE1'\nexport {sendTruckLogToCustoms as '40516e7e258a23fbfc95ed115874980e9c4dedda18'} from 'ACTIONS_MODULE1'\nexport {getTruckLogs as '60cd7b9c1de90cb658d4b00e637cb5c82adeca4656'} from 'ACTIONS_MODULE1'\n"],"names":[],"mappings":"wLAEA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OAQO,eAAe,EACpB,CAAyD,EAEzD,GAAI,CAEF,IAAM,EAAa,EAAA,cAAc,CAAC,SAAS,CAAC,GAC5C,GAAI,CAAC,EAAW,OAAO,CACrB,CADuB,KACjB,IAAI,EAAA,eAAe,CACvB,yBACA,EAAW,KAAK,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC,EAAK,KAEnC,CAAG,CADU,AACT,EADe,IAAI,CAAC,IAAI,CAAC,KACpB,CAAG,EAAM,OAAO,CAClB,GACN,CAAC,IAKR,IAAM,EAAY,MAAM,CAAA,EAAA,EAAA,gBAAA,AAAgB,IAGlC,EAAiB,MAAM,CAAA,EAAA,EAAA,oBAAA,AAAoB,EAAW,EAAW,QAGjE,EAAmB,CACvB,GAAG,EAAW,IAAI,CAClB,GAAI,CAAC,MAAM,EAAE,KAAK,GAAG,GAAG,CAAC,EAAE,KAAK,MAAM,GAAG,QAAQ,CAAC,IAAI,MAAM,CAAC,EAAG,GAAA,CAAI,CACpE,UAAW,IAAI,OAAO,WAAW,GACjC,eAAe,CACjB,EAKA,OAFA,MAAM,EAAe,SAAS,CAAC,GAExB,CACT,CAAE,MAAO,EAAO,CAEd,MAAM,AAAI,MADM,AACA,CADA,EAAA,EAAA,WAAA,AAAW,EAAC,GACJ,OAAO,CACjC,CACF,CAOO,eAAe,EACpB,CAAa,EAEb,GAAI,CAEF,GAAI,CAAC,GAA0B,UAAjB,OAAO,GAA8C,GAAG,CAA3B,EAAM,IAAI,GAAG,MAAM,CAC5D,MAAO,CACL,SAAS,EACT,MAAO,gBACT,EAIF,IAAM,EAAY,MAAM,CAAA,EAAA,EAAA,gBAAA,AAAgB,IAGlC,EAAiB,MAAM,CAAA,EAAA,EAAA,oBAAA,AAAoB,EAAW,EAAW,QAKvE,GAAI,CAFQ,AAEP,KAAK,CAFQ,EAAe,OAAO,CAAC,CAAE,GAAI,EAAM,IAAI,EAAG,GAG1D,MAAO,CACL,SAAS,EACT,MAAO,eACT,EAOF,GAHA,MAAM,IAAI,QAAQ,AAAC,GAAY,WAAW,EAAS,MAG/C,AAAgB,KAAK,GAAhB,MAAM,GACb,MAAO,CACL,SAAS,EACT,MAAO,oDACT,EASF,OALA,MAAM,EAAe,SAAS,CAC5B,CAAE,GAAI,EAAM,IAAI,EAAG,EACnB,CAAE,KAAM,CAAE,eAAe,CAAK,CAAE,GAG3B,CAAE,SAAS,CAAK,CACzB,CAAE,MAAO,EAAO,CAEd,MAAO,CACL,SAAS,EACT,MAHc,AAGP,CAHO,EAAA,EAAA,WAAA,AAAW,EAAC,GAGX,OACjB,AADwB,CAE1B,CACF,CAMO,eAAe,EACpB,EAAe,CAAC,CAChB,EAAgB,EAAE,EAElB,GAAI,CACF,IAAM,EAAY,MAAM,CAAA,EAAA,EAAA,gBAAA,AAAgB,IAClC,EAAiB,MAAM,CAAA,EAAA,EAAA,oBAAA,AAAoB,EAAW,EAAW,QAGjE,EAAY,KAAK,GAAG,CAAC,EAAG,KAAK,KAAK,CAAC,IACnC,EAAa,KAAK,GAAG,CAAC,IAAK,KAAK,GAAG,CAAC,EAAG,KAAK,KAAK,CAAC,KAIlD,EAAQ,MAAM,EAAe,cAAc,CAAC,CAAC,GAuBnD,MAAO,CACL,KAbqB,CAaf,AArBK,MAAM,EAChB,IAAI,CAAC,CAAC,GACN,IAAI,CAAC,CAAE,UAAW,CAAC,CAAE,GACrB,IAAI,CATM,AAAC,AASN,IATkB,CAAC,CAAI,GAU5B,KAAK,CAAC,GACN,OAAO,EAAA,EAGkB,GAAG,CAAC,AAAC,IAC/B,GAAM,KAAE,CAAG,WAAE,CAAS,CAAE,GAAG,EAAK,CAAG,EACnC,MAAO,CACL,GAAG,CAAG,CACN,UAAgC,UAArB,OAAO,EACd,EACC,aAAqB,KAClB,EAAU,WAAW,GACrB,IAAI,KAAK,GAAW,WAAW,EACzC,CACF,SAIE,EACA,KAAM,EACN,MAAO,EACP,WAAY,KAAK,IAAI,CAAC,EAAQ,EAChC,CACF,CAAE,MAAO,EAAO,CAEd,MAAM,AAAI,MAAM,AADA,CAAA,EAAA,EAAA,WAAA,AAAW,EAAC,GACJ,OAAO,CACjC,CACF,CAMO,eAAe,EAAY,CAAa,EAC7C,IAAM,EAAY,MAAM,CAAA,EAAA,EAAA,gBAAA,AAAgB,IAClC,EAAiB,MAAM,CAAA,EAAA,EAAA,oBAAA,AAAoB,EAAW,EAAW,QAEjE,EAAM,MAAM,EAAe,OAAO,CAAC,CAAE,GAAI,CAAM,GAErD,GAAI,CAAC,EAAK,OAAO,KAGjB,GAAM,KAAE,CAAG,WAAE,CAAS,CAAE,GAAG,EAAS,CAAG,EACvC,MAAO,CACL,GAAG,CAAO,CACV,UAAgC,UAArB,OAAO,EACd,EACC,aAAqB,KAClB,EAAU,WAAW,GACrB,IAAI,KAAK,GAAW,WAAW,EACzC,CACF,CAOO,eAAe,EACpB,CAAa,CACb,CAAsE,EAEtE,GAAI,CAEF,IAAM,EAAY,MAAM,CAAA,EAAA,EAAA,gBAAA,AAAgB,IAGlC,EAAiB,MAAM,CAAA,EAAA,EAAA,oBAAA,AAAoB,EAAW,EAAW,QAGjE,EAAc,MAAM,EAAe,OAAO,CAAC,CAAE,GAAI,CAAM,GAE7D,GAAI,CAAC,EACH,MAAO,CACL,IAFc,KAEL,EACT,MAAO,eACT,EAIF,GAAI,EAAY,aAAa,CAC3B,CAD6B,KACtB,CACL,SAAS,EACT,MAAO,iDACT,EAIF,GAAI,OAAO,IAAI,CAAC,GAAS,MAAM,CAAG,EAAG,CACnC,IAAM,EAAa,EAAA,cAAc,CAAC,OAAO,GAAG,SAAS,CAAC,GACtD,GAAI,CAAC,EAAW,OAAO,CACrB,CADuB,KACjB,IAAI,EAAA,eAAe,CACvB,sBACA,EAAW,KAAK,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC,EAAK,KAEnC,CAAG,CADU,AACT,EADe,IAAI,CAAC,IAAI,CAAC,KACpB,CAAG,EAAM,OAAO,CAClB,GACN,CAAC,GAGV,CAGA,IAAM,EAAa,CACjB,GAAG,CAAW,CACd,GAAG,CAAO,CACV,GAAI,EAAY,EAAE,CAClB,UAAW,EAAY,SAAS,CAChC,cAAe,EAAY,aAAa,CACxC,UAAW,IAAI,OAAO,WAAW,EACnC,CAEA,OAAM,EAAe,SAAS,CAC5B,CAAE,GAAI,CAAM,EACZ,CAAE,KAAM,CAAW,GAIrB,IAAM,EAAa,MAAM,EAAe,OAAO,CAAC,CAAE,GAAI,CAAM,GAE5D,GAAI,CAAC,EACH,MAAO,CACL,GAFa,MAEJ,EACT,MAAO,gCACT,EAMF,IAAM,EAA0B,CAC9B,GAFU,AAEN,EAAI,EAAE,CACV,UAAW,EAAI,SAAS,CACxB,MAAO,EAAI,KAAK,CAChB,WAAY,EAAI,UAAU,CAC1B,UAAW,EAAI,SAAS,CACxB,SAAU,EAAI,QAAQ,CACtB,SAAU,EAAI,QAAQ,CACtB,OAAQ,EAAI,MAAM,CAClB,YAAa,EAAI,WAAW,CAC5B,mBAAoB,EAAI,kBAAkB,CAC1C,qBAAsB,EAAI,oBAAoB,CAC9C,cAAe,EAAI,aAAa,CAChC,UAAW,AAAyB,iBAAlB,EAAI,SAAS,CAC3B,EAAI,SAAS,CACZ,EAAI,SAAS,YAAY,KACtB,EAAI,SAAS,CAAC,WAAW,GACxB,EAAI,SAAS,CAAG,IAAI,KAAK,EAAI,SAAS,EAAE,WAAW,GAAK,IAAI,OAAO,WAAW,EACzF,EAEA,MAAO,CACL,SAAS,EACT,IAAK,CACP,CACF,CAAE,MAAO,EAAO,CAEd,MAAO,CACL,SAAS,EACT,MAHc,AAGP,CAHO,EAAA,EAAA,WAAA,AAAW,EAAC,GAGX,OAAO,AACxB,CACF,CACF,0CA/RsB,EA8CA,EA2DA,EAsDA,EAyBA,IAxLA,CAAA,EAAA,EAAA,uBAAA,EAAA,EAAA,6CAAA,MA8CA,CAAA,EAAA,EAAA,uBAAA,EAAA,EAAA,6CAAA,MA2DA,CAAA,EAAA,EAAA,uBAAA,EAAA,EAAA,6CAAA,MAsDA,CAAA,EAAA,EAAA,uBAAA,EAAA,EAAA,6CAAA,MAyBA,CAAA,EAAA,EAAA,uBAAA,EAAA,EAAA,6CAAA,6GCrMtB,IAAA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA"}
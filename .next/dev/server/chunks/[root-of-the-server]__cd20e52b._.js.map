{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///Users/bayarbayasgalanulambayar/Downloads/truck-weighing-dashboard/lib/auth/session.ts"],"sourcesContent":["\"use server\"\n\nimport { cookies } from \"next/headers\"\nimport { redirect } from \"next/navigation\"\n\nconst COMPANY_ID_COOKIE = \"company-id\"\nconst WORKER_ID_COOKIE = \"worker-id\"\nconst SESSION_EXPIRES_COOKIE = \"session-expires\"\n\n// Session duration: 7 days (in seconds)\nconst SESSION_MAX_AGE = 60 * 60 * 24 * 7\n\n// Check if cookies should be secure (production or forced)\nconst isSecure = process.env.NODE_ENV === \"production\" || process.env.FORCE_SECURE_COOKIES === \"true\"\n\nexport interface SessionData {\n  companyId: string\n  workerId: string\n  expiresAt: number\n}\n\n/**\n * Get the active company context from session\n * Throws if no company is set (forces login)\n * Validates session expiration\n */\nexport async function getActiveCompany(): Promise<string> {\n  const cookieStore = await cookies()\n  const companyId = cookieStore.get(COMPANY_ID_COOKIE)?.value\n  const expiresAt = cookieStore.get(SESSION_EXPIRES_COOKIE)?.value\n\n  if (!companyId) {\n    redirect(\"/login\")\n  }\n\n  // Check expiration\n  if (expiresAt) {\n    const expires = parseInt(expiresAt, 10)\n    if (isNaN(expires) || expires < Date.now()) {\n      // Session expired, clear and redirect\n      await clearSession()\n      redirect(\"/login\")\n    }\n  }\n\n  return companyId\n}\n\n/**\n * Get the current session data (companyId + workerId)\n * Returns null if not authenticated or expired\n */\nexport async function getSession(): Promise<SessionData | null> {\n  const cookieStore = await cookies()\n  const companyId = cookieStore.get(COMPANY_ID_COOKIE)?.value\n  const workerId = cookieStore.get(WORKER_ID_COOKIE)?.value\n  const expiresAt = cookieStore.get(SESSION_EXPIRES_COOKIE)?.value\n\n  if (!companyId || !workerId) {\n    return null\n  }\n\n  // Check expiration\n  if (expiresAt) {\n    const expires = parseInt(expiresAt, 10)\n    if (isNaN(expires) || expires < Date.now()) {\n      // Session expired\n      await clearSession()\n      return null\n    }\n  }\n\n  return {\n    companyId,\n    workerId,\n    expiresAt: expiresAt ? parseInt(expiresAt, 10) : Date.now() + SESSION_MAX_AGE * 1000,\n  }\n}\n\n/**\n * Set session expiration timestamp\n */\nfunction setSessionExpiration(cookieStore: ReturnType<typeof cookies>) {\n  const expiresAt = Date.now() + SESSION_MAX_AGE * 1000\n  cookieStore.set(SESSION_EXPIRES_COOKIE, expiresAt.toString(), {\n    httpOnly: true,\n    secure: isSecure,\n    sameSite: \"lax\",\n    maxAge: SESSION_MAX_AGE,\n    path: \"/\",\n  })\n}\n\n/**\n * Set session after successful login\n * Includes expiration timestamp\n */\nexport async function setSession(companyId: string, workerId: string) {\n  const cookieStore = await cookies()\n  \n  // Validate inputs\n  if (!companyId || !workerId) {\n    throw new Error(\"Company ID and Worker ID are required\")\n  }\n\n  // Set cookies with httpOnly for security\n  cookieStore.set(COMPANY_ID_COOKIE, companyId, {\n    httpOnly: true,\n    secure: isSecure,\n    sameSite: \"lax\",\n    maxAge: SESSION_MAX_AGE,\n    path: \"/\",\n  })\n\n  cookieStore.set(WORKER_ID_COOKIE, workerId, {\n    httpOnly: true,\n    secure: isSecure,\n    sameSite: \"lax\",\n    maxAge: SESSION_MAX_AGE,\n    path: \"/\",\n  })\n\n  setSessionExpiration(cookieStore)\n}\n\n/**\n * Set company session (partial session - company logged in, worker not selected yet)\n * Includes expiration timestamp\n */\nexport async function setCompanySession(companyId: string) {\n  const cookieStore = await cookies()\n  \n  if (!companyId) {\n    throw new Error(\"Company ID is required\")\n  }\n\n  cookieStore.set(COMPANY_ID_COOKIE, companyId, {\n    httpOnly: true,\n    secure: isSecure,\n    sameSite: \"lax\",\n    maxAge: SESSION_MAX_AGE,\n    path: \"/\",\n  })\n\n  setSessionExpiration(cookieStore)\n}\n\n/**\n * Set worker ID in existing company session\n * Refreshes expiration\n */\nexport async function setWorkerInSession(workerId: string) {\n  const cookieStore = await cookies()\n  \n  if (!workerId) {\n    throw new Error(\"Worker ID is required\")\n  }\n\n  // Verify company session exists\n  const companyId = cookieStore.get(COMPANY_ID_COOKIE)?.value\n  if (!companyId) {\n    throw new Error(\"Company session not found\")\n  }\n\n  cookieStore.set(WORKER_ID_COOKIE, workerId, {\n    httpOnly: true,\n    secure: isSecure,\n    sameSite: \"lax\",\n    maxAge: SESSION_MAX_AGE,\n    path: \"/\",\n  })\n\n  setSessionExpiration(cookieStore)\n}\n\n/**\n * Refresh session expiration\n */\nexport async function refreshSession() {\n  const cookieStore = await cookies()\n  const companyId = cookieStore.get(COMPANY_ID_COOKIE)?.value\n  const workerId = cookieStore.get(WORKER_ID_COOKIE)?.value\n\n  if (companyId && workerId) {\n    setSessionExpiration(cookieStore)\n  }\n}\n\n/**\n * Clear session on logout\n */\nexport async function clearSession() {\n  const cookieStore = await cookies()\n  cookieStore.delete(COMPANY_ID_COOKIE)\n  cookieStore.delete(WORKER_ID_COOKIE)\n  cookieStore.delete(SESSION_EXPIRES_COOKIE)\n}\n\n/**\n * Check if user is authenticated (both company and worker)\n * Also checks expiration\n */\nexport async function isAuthenticated(): Promise<boolean> {\n  const session = await getSession()\n  return session !== null\n}\n\n/**\n * Check if company is logged in (partial authentication)\n * Also checks expiration\n */\nexport async function isCompanyAuthenticated(): Promise<boolean> {\n  const cookieStore = await cookies()\n  const companyId = cookieStore.get(COMPANY_ID_COOKIE)?.value\n  const expiresAt = cookieStore.get(SESSION_EXPIRES_COOKIE)?.value\n\n  if (!companyId) {\n    return false\n  }\n\n  // Check expiration\n  if (expiresAt) {\n    const expires = parseInt(expiresAt, 10)\n    if (isNaN(expires) || expires < Date.now()) {\n      return false\n    }\n  }\n\n  return true\n}\n\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 261, "column": 0}, "map": {"version":3,"sources":["file:///Users/bayarbayasgalanulambayar/Downloads/truck-weighing-dashboard/lib/db/client.ts"],"sourcesContent":["import { MongoClient, Db } from \"mongodb\"\n\nif (!process.env.MONGODB_URI) {\n  throw new Error('Invalid/Missing environment variable: \"MONGODB_URI\"')\n}\n\nconst uri = process.env.MONGODB_URI\nconst options = {}\n\nlet client: MongoClient\nlet clientPromise: Promise<MongoClient>\n\nif (process.env.NODE_ENV === \"development\") {\n  // In development mode, use a global variable so that the value\n  // is preserved across module reloads caused by HMR (Hot Module Replacement).\n  let globalWithMongo = global as typeof globalThis & {\n    _mongoClientPromise?: Promise<MongoClient>\n  }\n\n  if (!globalWithMongo._mongoClientPromise) {\n    client = new MongoClient(uri, options)\n    globalWithMongo._mongoClientPromise = client.connect()\n  }\n  clientPromise = globalWithMongo._mongoClientPromise\n} else {\n  // In production mode, it's best to not use a global variable.\n  client = new MongoClient(uri, options)\n  clientPromise = client.connect()\n}\n\n// Export a module-scoped MongoClient promise. By doing this in a\n// separate module, the client can be shared across functions.\nexport default clientPromise\n\n/**\n * Get the main database instance\n */\nexport async function getDatabase(): Promise<Db> {\n  const client = await clientPromise\n  return client.db(process.env.MONGODB_DB_NAME || \"truck-weighing-dashboard\")\n}\n\n"],"names":[],"mappings":";;;;;;AAAA;;AAEA,IAAI,CAAC,QAAQ,GAAG,CAAC,WAAW,EAAE;IAC5B,MAAM,IAAI,MAAM;AAClB;AAEA,MAAM,MAAM,QAAQ,GAAG,CAAC,WAAW;AACnC,MAAM,UAAU,CAAC;AAEjB,IAAI;AACJ,IAAI;AAEJ,wCAA4C;IAC1C,+DAA+D;IAC/D,6EAA6E;IAC7E,IAAI;IAIJ,IAAI,CAAC,gBAAgB,mBAAmB,EAAE;QACxC,SAAS,IAAI,sHAAW,CAAC,KAAK;QAC9B,gBAAgB,mBAAmB,GAAG,OAAO,OAAO;IACtD;IACA,gBAAgB,gBAAgB,mBAAmB;AACrD;;uCAQe;AAKR,eAAe;IACpB,MAAM,SAAS,MAAM;IACrB,OAAO,OAAO,EAAE,CAAC,QAAQ,GAAG,CAAC,eAAe,IAAI;AAClD"}},
    {"offset": {"line": 296, "column": 0}, "map": {"version":3,"sources":["file:///Users/bayarbayasgalanulambayar/Downloads/truck-weighing-dashboard/app/api/debug/collections/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\"\nimport { getSession } from \"@/lib/auth/session\"\nimport { getDatabase } from \"@/lib/db/client\"\n\n/**\n * GET /api/debug/collections - Debug endpoint to show all collections for the current company\n * This helps identify which collections exist and where data is being saved\n */\nexport async function GET() {\n  try {\n    const session = await getSession()\n    if (!session) {\n      return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 })\n    }\n    \n    const companyId = session.companyId\n    const db = await getDatabase()\n    \n    // Get all collections in the database\n    const allCollections = await db.listCollections().toArray()\n    \n    // Filter collections that belong to this company\n    const companyCollections = allCollections\n      .filter(col => col.name.startsWith(`company_${companyId}_`))\n      .map(col => col.name)\n    \n    // Get collection names and their document counts\n    const collectionsWithCounts = await Promise.all(\n      companyCollections.map(async (collectionName) => {\n        const collection = db.collection(collectionName)\n        const count = await collection.countDocuments()\n        const sample = await collection.find({}).limit(3).toArray()\n        \n        return {\n          name: collectionName,\n          count,\n          sample: sample.map((doc: any) => {\n            const { _id, ...data } = doc\n            return data\n          }),\n        }\n      })\n    )\n    \n    return NextResponse.json({\n      companyId,\n      collections: collectionsWithCounts,\n      allCollectionNames: companyCollections,\n      note: `All data for company \"${companyId}\" is saved in collections starting with \"company_${companyId}_\"`,\n    }, { status: 200 })\n  } catch (error) {\n    console.error(\"Error getting collections:\", error)\n    return NextResponse.json(\n      { error: error instanceof Error ? error.message : \"Unknown error\" },\n      { status: 500 }\n    )\n  }\n}\n\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;AAMO,eAAe;IACpB,IAAI;QACF,MAAM,UAAU,MAAM,IAAA,sIAAU;QAChC,IAAI,CAAC,SAAS;YACZ,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAe,GAAG;gBAAE,QAAQ;YAAI;QACpE;QAEA,MAAM,YAAY,QAAQ,SAAS;QACnC,MAAM,KAAK,MAAM,IAAA,oIAAW;QAE5B,sCAAsC;QACtC,MAAM,iBAAiB,MAAM,GAAG,eAAe,GAAG,OAAO;QAEzD,iDAAiD;QACjD,MAAM,qBAAqB,eACxB,MAAM,CAAC,CAAA,MAAO,IAAI,IAAI,CAAC,UAAU,CAAC,CAAC,QAAQ,EAAE,UAAU,CAAC,CAAC,GACzD,GAAG,CAAC,CAAA,MAAO,IAAI,IAAI;QAEtB,iDAAiD;QACjD,MAAM,wBAAwB,MAAM,QAAQ,GAAG,CAC7C,mBAAmB,GAAG,CAAC,OAAO;YAC5B,MAAM,aAAa,GAAG,UAAU,CAAC;YACjC,MAAM,QAAQ,MAAM,WAAW,cAAc;YAC7C,MAAM,SAAS,MAAM,WAAW,IAAI,CAAC,CAAC,GAAG,KAAK,CAAC,GAAG,OAAO;YAEzD,OAAO;gBACL,MAAM;gBACN;gBACA,QAAQ,OAAO,GAAG,CAAC,CAAC;oBAClB,MAAM,EAAE,GAAG,EAAE,GAAG,MAAM,GAAG;oBACzB,OAAO;gBACT;YACF;QACF;QAGF,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB;YACA,aAAa;YACb,oBAAoB;YACpB,MAAM,CAAC,sBAAsB,EAAE,UAAU,iDAAiD,EAAE,UAAU,EAAE,CAAC;QAC3G,GAAG;YAAE,QAAQ;QAAI;IACnB,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,8BAA8B;QAC5C,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QAAgB,GAClE;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}
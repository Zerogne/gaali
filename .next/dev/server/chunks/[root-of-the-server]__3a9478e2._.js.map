{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/bayarbayasgalanulambayar/Downloads/truck-weighing-dashboard/proxy.ts"],"sourcesContent":["import { NextResponse } from \"next/server\"\n\n/**\n * Proxy to protect routes and validate authentication\n * Uses Next.js Proxy API (replaces deprecated middleware)\n * Redirects unauthenticated users to login page\n */\nexport default async function proxy(request: Request) {\n  const url = new URL(request.url)\n  const { pathname } = url\n\n  // Allow public routes\n  if (\n    pathname.startsWith('/login') ||\n    pathname.startsWith('/_next') ||\n    (pathname.startsWith('/api/companies') && pathname === '/api/companies') || // Only allow GET /api/companies (no params)\n    pathname.startsWith('/api/auth') ||\n    pathname.startsWith('/api/seed') || // Allow seed endpoint\n    pathname.startsWith('/api/reset-passwords') || // Allow password reset endpoint\n    pathname.startsWith('/api/debug') || // Allow debug endpoints (protected by auth in route itself)\n    pathname.match(/\\.(ico|png|jpg|jpeg|svg|gif|webp|css|js|woff|woff2|ttf|eot)$/)\n  ) {\n    return NextResponse.next()\n  }\n\n  // Get cookies from request\n  const cookieHeader = request.headers.get('cookie') || ''\n  const cookies = parseCookies(cookieHeader)\n  \n  const companyId = cookies['company-id']\n  const workerId = cookies['worker-id']\n  const expiresAt = cookies['session-expires']\n\n  // Check if session exists\n  if (!companyId || !workerId) {\n    // Redirect to login if not authenticated\n    if (pathname.startsWith('/api/')) {\n      // API routes return 401 instead of redirect\n      return NextResponse.json(\n        { error: 'Authentication required' },\n        { status: 401 }\n      )\n    }\n    return NextResponse.redirect(new URL('/login', url))\n  }\n\n  // Check session expiration\n  if (expiresAt) {\n    const expires = parseInt(expiresAt, 10)\n    if (!isNaN(expires) && expires < Date.now()) {\n      // Session expired\n      const response = pathname.startsWith('/api/')\n        ? NextResponse.json({ error: 'Session expired' }, { status: 401 })\n        : NextResponse.redirect(new URL('/login', url))\n      \n      // Clear expired cookies\n      response.cookies.delete('company-id')\n      response.cookies.delete('worker-id')\n      response.cookies.delete('session-expires')\n      \n      return response\n    }\n  }\n\n  // Redirect to dashboard if accessing login while fully authenticated\n  if (pathname.startsWith('/login') && companyId && workerId) {\n    return NextResponse.redirect(new URL('/', url))\n  }\n\n  return NextResponse.next()\n}\n\n/**\n * Parse cookies from cookie header string\n */\nfunction parseCookies(cookieHeader: string): Record<string, string> {\n  const cookies: Record<string, string> = {}\n  if (!cookieHeader) return cookies\n\n  cookieHeader.split(';').forEach((cookie) => {\n    const [name, ...rest] = cookie.trim().split('=')\n    if (name) {\n      cookies[name] = rest.join('=').trim()\n    }\n  })\n\n  return cookies\n}\n\nexport const config = {\n  matcher: [\n    /*\n     * Match all request paths except for the ones starting with:\n     * - _next/static (static files)\n     * - _next/image (image optimization files)\n     * - favicon.ico (favicon file)\n     * - public folder files (already handled above)\n     */\n    '/((?!_next/static|_next/image|favicon.ico|.*\\\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)',\n  ],\n}\n\n"],"names":[],"mappings":";;;;;;AAAA;;AAOe,eAAe,MAAM,OAAgB;IAClD,MAAM,MAAM,IAAI,IAAI,QAAQ,GAAG;IAC/B,MAAM,EAAE,QAAQ,EAAE,GAAG;IAErB,sBAAsB;IACtB,IACE,SAAS,UAAU,CAAC,aACpB,SAAS,UAAU,CAAC,aACnB,SAAS,UAAU,CAAC,qBAAqB,aAAa,oBAAqB,4CAA4C;IACxH,SAAS,UAAU,CAAC,gBACpB,SAAS,UAAU,CAAC,gBAAgB,sBAAsB;IAC1D,SAAS,UAAU,CAAC,2BAA2B,gCAAgC;IAC/E,SAAS,UAAU,CAAC,iBAAiB,4DAA4D;IACjG,SAAS,KAAK,CAAC,iEACf;QACA,OAAO,8IAAY,CAAC,IAAI;IAC1B;IAEA,2BAA2B;IAC3B,MAAM,eAAe,QAAQ,OAAO,CAAC,GAAG,CAAC,aAAa;IACtD,MAAM,UAAU,aAAa;IAE7B,MAAM,YAAY,OAAO,CAAC,aAAa;IACvC,MAAM,WAAW,OAAO,CAAC,YAAY;IACrC,MAAM,YAAY,OAAO,CAAC,kBAAkB;IAE5C,0BAA0B;IAC1B,IAAI,CAAC,aAAa,CAAC,UAAU;QAC3B,yCAAyC;QACzC,IAAI,SAAS,UAAU,CAAC,UAAU;YAChC,4CAA4C;YAC5C,OAAO,8IAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAA0B,GACnC;gBAAE,QAAQ;YAAI;QAElB;QACA,OAAO,8IAAY,CAAC,QAAQ,CAAC,IAAI,IAAI,UAAU;IACjD;IAEA,2BAA2B;IAC3B,IAAI,WAAW;QACb,MAAM,UAAU,SAAS,WAAW;QACpC,IAAI,CAAC,MAAM,YAAY,UAAU,KAAK,GAAG,IAAI;YAC3C,kBAAkB;YAClB,MAAM,WAAW,SAAS,UAAU,CAAC,WACjC,8IAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAkB,GAAG;gBAAE,QAAQ;YAAI,KAC9D,8IAAY,CAAC,QAAQ,CAAC,IAAI,IAAI,UAAU;YAE5C,wBAAwB;YACxB,SAAS,OAAO,CAAC,MAAM,CAAC;YACxB,SAAS,OAAO,CAAC,MAAM,CAAC;YACxB,SAAS,OAAO,CAAC,MAAM,CAAC;YAExB,OAAO;QACT;IACF;IAEA,qEAAqE;IACrE,IAAI,SAAS,UAAU,CAAC,aAAa,aAAa,UAAU;QAC1D,OAAO,8IAAY,CAAC,QAAQ,CAAC,IAAI,IAAI,KAAK;IAC5C;IAEA,OAAO,8IAAY,CAAC,IAAI;AAC1B;AAEA;;CAEC,GACD,SAAS,aAAa,YAAoB;IACxC,MAAM,UAAkC,CAAC;IACzC,IAAI,CAAC,cAAc,OAAO;IAE1B,aAAa,KAAK,CAAC,KAAK,OAAO,CAAC,CAAC;QAC/B,MAAM,CAAC,MAAM,GAAG,KAAK,GAAG,OAAO,IAAI,GAAG,KAAK,CAAC;QAC5C,IAAI,MAAM;YACR,OAAO,CAAC,KAAK,GAAG,KAAK,IAAI,CAAC,KAAK,IAAI;QACrC;IACF;IAEA,OAAO;AACT;AAEO,MAAM,SAAS;IACpB,SAAS;QACP;;;;;;KAMC,GACD;KACD;AACH"}}]
}